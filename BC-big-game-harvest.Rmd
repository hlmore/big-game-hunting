---
title: "BC big game harvesting"
output: html_notebook
---

<!-- 
Execute a chunk: click the *Run* button within the chunk or place your cursor inside it and press *Ctrl+Shift+Enter*.

Add a new chunk:  click the *Insert Chunk* button on the toolbar or press *Ctrl+Alt+I*. 

https://stackoverflow.com/a/4714080
- @ accesses a slot in an S4 object like an object in spatialPolygons class.  Find slot names using slotNames(spPolygonObjectName).  Find contents of a slot using slot(spPolygonObjectName, "slotName").
- $ accesses a named variable in an S4 object or a dataframe or a list
-->

This notebook analyzes data on big game harvesting in British Columbia, Canada.  It uses the following publicly-available data from the Government of BC:

* Hunting kills dataset covering 1976--2018 from: https://catalogue.data.gov.bc.ca/dataset/big-game-harvest-statistics-1976-2018
  - I used the .xlsx version of the dataset rather than the .csv version, because the csv had half the header text cut off and does not have descriptions of field codes
  - The BC government has a Shiny app for this data at:  https://kootenaywildlife.shinyapps.io/BCHarvestData/
* Annual population of BC from:  https://www2.gov.bc.ca/gov/content/data/statistics/people-population-community/population/population-estimates
* Hunting licence sales from:
https://catalogue.data.gov.bc.ca/dataset/hunting-sales-statistics-2005-2019
* BC Wildlife management units from:
https://catalogue.data.gov.bc.ca/dataset/wildlife-management-units

Some possibilities for data on species populations (incomplete):

* GRIZZLY BEAR:  bc_grizzly_population_estimates_2015_and_2018_by_gbpu_population_sub_units from https://catalogue.data.gov.bc.ca/dataset/grizzly-bear-population-estimates
* MOOSE:  Kuzyk -- 2016 -- Provincial population and harvest estimates of moose in British Columbia
* ELK:  here, but no public access:  https://catalogue.data.gov.bc.ca/dataset/elk-cervus-elaphus-populations-scale-1-250-000
* MULE DEER:  maybe in the aerial survey of large mammals, but access restricted:  https://catalogue.data.gov.bc.ca/dataset/aerial-survey-large-mammals-1994-1997
* CARIBOU:  herd locations:  https://catalogue.data.gov.bc.ca/dataset/caribou-herd-locations-for-bc
* WILDLIFE SPECIES INVENTORY:  https://catalogue.data.gov.bc.ca/dataset/wildlife-species-inventory-results-by-area-all
* Francis Iredale (via Jim Gnapp) suggests for species population data:
  - http://a100.gov.bc.ca/pub/siwe/search_reset.do
  - https://a100.gov.bc.ca/pub/clir/enterCLIR.do?redirect=Y
  
Other possible resources:

* http://www.env.gov.bc.ca/fw/wildlife/management-issues/docs/kootenay_mule_deer_faq.pdf
* try getting population data from here:  http://a100.gov.bc.ca/pub/siwe/search_reset.do
* BC hunter expenditure survey:  http://www.env.gov.bc.ca/fw/wildlife/bc_hunt_value.html
* BC harvest allocation policies:  http://www.env.gov.bc.ca/fw/wildlife/harvest_alloc/
* region and wmu info:  https://www2.gov.bc.ca/gov/content/sports-culture/recreation/fishing-hunting/hunting/regulations-synopsis
* BC regions map:  https://governmentofbc.maps.arcgis.com/home/webmap/viewer.html
* BC data sets:  catalogue.data.gov.bc.ca/dataset
* BC game management zones:  https://catalogue.data.gov.bc.ca/dataset/game-management-zones

Author:  Heather More
Started:  2020-11-24 

```{r}
# INPUTS
# Which species to plot
speciesToShow <- c("DEMU", "BEAB")#"ELK", "DEMU", "DEWT", "MOOS", "BEAB", "WOLF", "CARI", "GOAT", "SHEE", "BEAG", "COUG")
# Which WMU to plot -- as number, without dash, single digit as 0X
wmuToShow <- c(332)
# Which hunting region to plot -- as number, or as string if 7A or 7B
huntingRegionToShow <- c("7A")
# Choose to filter by province totals, hunting regions, or wmus
# Options:  "province", "huntingRegion", "wmu"
filterBy <- "wmu"
```

```{r}
# LOAD PACKAGES
library(readxl) # read Excel spreadsheets
library(tidyverse) # data manipulation
library(janitor) # data cleaning
library(leaflet)  # mapping
library(geojsonio)  # read geojson files
library(rmapshaper)  # simplify areas on maps
library(rgeos)  # functions for handling geographic regions
library(geosphere)  # functions for handling sperical regions (i.e. lat/long coordinages)
library(RColorBrewer)  # colour schemes
library(htmltools)  # HTML formatting for map labels

# CUSTOM FUNCTIONS
# Convert names of colours to hex
source("GetColourHex.R")
# Custom functions for this code
source("CustomFunctions.R")

# INPUT FILES
# Directory containing data
data_dir = "D:/Documents/Code/BC big game harvesting/data"
# Historical hunting kills
data_huntingKills <- list(
  "path" = data_dir,
  "fileName" = "big-game-harvest-statistics-1976-2018.xlsx",
  "sheetName" = "BGHS",
  "columnTypes" = c("numeric",  # hunt year
                     "text",  # species
                     "text",  # CI
                     "numeric",  # prov flag
                     "text",  # WMU
                     "text",  # region
                     rep("numeric", 14)  # remaining columns
                    )
)
# Historical population of BC
data_bcPopulation <- list(
  "path" = data_dir,
  "fileName" = "pop_bc_annual_estimates_clean.xlsx",
  "sheetName" = "data"
)
# Lists of WMUs and their corresponding hunting regions
data_wmuHuntingRegions <- list(
  "path" = data_dir,
  "fileName" = "conversions_hunting-region-wmus.xlsx",
  "sheetName" = "wmu_data",
  "columnTypes" = c("text",  # WMU id as string
                    "numeric",  # WMU id as int
                    "text",  # hunting region
                    "text"  # notes
                    )
)
# Lists of hunting region names
data_regionNames <- list(
  "path" = data_dir,
  "fileName" = "conversions_hunting-region-wmus.xlsx",
  "sheetName" = "region_names",
  "columnTypes" = c("text",  # region id as string
                    "text"  # region name as string
                    )
)
# List of species included in the hunting dataset and their attributes
data_species <- list(
  "path" = data_dir,
  "fileName" = "conversions_species.xlsx",
  "sheetName" = "data"
)
# Map of WMUs
map_wmu <- list(
  "path" = data_dir,
  "fileName" = "wmu-map/WAA_WILDLIFE_MGMT_UNITS_SVW.geojson"
)

# LINKS
# Site to preview different basemaps:  http://leaflet-extras.github.io/leaflet-providers/preview/index.html
#tilesURL <- "http://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}"
tilesURL <- "https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}"
```

```{r}
# LOAD DATA

# Hunting kills
df_huntingKills <- ReadExcel(data_huntingKills)

# BC population
df_pop <- ReadExcel(data_bcPopulation)

# Conversions between WMU numbers and hunting regions
df_wmuRegions <- ReadExcel(data_wmuHuntingRegions)

# Hunting region names
df_regionNames <- ReadExcel(data_regionNames)

# Species names and characteristics
df_species <- ReadExcel(data_species)

# Map of wildlife management units.
# https://rstudio.github.io/leaflet/json.html
# Simplify boundaries so they render faster -- size goes from 4,535,784 to 963,312 bytes
sp_wmus <- geojsonio::geojson_read(file.path(map_wmu[["path"]], map_wmu[["fileName"]], 
                           fsep = .Platform$file.sep), what = "sp") %>% 
  rmapshaper::ms_simplify()

```
```{r}
# FUNCTIONS

# Look up full name of species based on code
# Input is species code as string, e.g. "BEAB"
# Output is species name as string, e.g. "Black bear"
GetSpeciesName <- function(speciesCode) {
  species_name <- df_species %>% 
    filter(code==speciesCode) %>% 
    pull(name)
  return(species_name)
}

# Find colour corresponding to species
# Input is species code as string, e.g. "BEAB"
# Output is colour as hex string, e.g. "#000000"
GetSpeciesColour <- function(speciesCode) {
  species_colour <- df_species %>% 
    filter(code==speciesCode) %>% 
    pull(colour) %>% 
    GetColourHex()
  return(species_colour)
}

```

```{r}
# INVESTIGATE DATA
print(paste("Hunt years:  ", 
            paste(min(df_huntingKills$hunt_year)), 
            "--", 
            paste(max(df_huntingKills$hunt_year)), 
            collapse = ''
            )
      )
print(paste('Species:  ', 
            paste(lapply(unique(df_huntingKills$species), GetSpeciesName), 
                  collapse = ', ')
            )
      )
print(paste('WMUs:  ', 
            paste(length(unique(df_huntingKills$wmu)))
            )
      )
print(paste('Regions:  ', 
            paste(length(unique(df_huntingKills$region)))
            )
      )
```

```{r}
# FILTER

# Filter hunting data by selected region(s) and species
# Filter by region to show -- whole-province, selected WMU(s), or selected hunting region(s)
# df_huntingKills$prov_flag
#     9 for whole-province data
#     0 otherwise
# df_huntingKills$wmu
#     999 for whole-province data
#     X00 for all of region X
#     7A or 7B for all of region 7A or 7B
if (filterBy=="province") {
  df_filtered <- df_huntingKills %>% 
    filter(prov_flag==9)
} else if(filterBy=="huntingRegion") {
  if(is.character(huntingRegionToShow)) {
    df_filtered <- df_huntingKills %>% 
      filter(wmu==huntingRegionToShow)
  } else if (is.numeric(huntingRegionToShow)) {
    df_filtered <- df_huntingKills %>% 
      filter(wmu==(100*huntingRegionToShow + 99))
  }
} else if(filterBy=="wmu") {
  df_filtered <- df_huntingKills %>% 
    filter(wmu==wmuToShow)
}
# Filter by species to show
df_filtered <- df_filtered %>% 
  filter(species %in% speciesToShow)

# Filter population data so years match hunting data
df_pop_years <- df_pop %>% 
  filter(year >= min(df_filtered$hunt_year) 
         & year <= max(df_filtered$hunt_year)) %>% 
  rename(population_human = population)
```

```{r}
# ADD OTHER VARIABLES OF INTEREST TO DATAFRAME

# Add population data
df_filtered <- df_filtered %>% 
  left_join(df_pop_years, by = c("hunt_year" = "year"))

# Do some calculations
df_filtered <- df_filtered %>% 
  rowwise() %>% # sum over each row:  https://stackoverflow.com/a/33806717
  mutate(
    total_kills = sum(resident_kills, non_resident_kills, na.rm=TRUE),
    total_hunters = sum(resident_hunters, non_resident_hunters, na.rm=TRUE),
    total_days = sum(resident_days, non_resident_days, na.rm=TRUE),
    kills_per_hunter = total_kills/total_hunters,
    days_per_hunter = total_days/total_hunters,
    days_per_kill = total_days/total_kills)
```

```{r}
# PLOTTING FUNCTIONS

# Theme
UseTheme <- function() {
    theme_light()
}

# Line and point styles
FormatLines <- function() {
  geom_line()
}
FormatPoints <- function() {
  geom_point(size=2, alpha=0.7)
}

# Function to use species-specific colours
UseSpeciesColours <- function() {
     scale_colour_manual(
       name = "Species",  # legend title
       values = paste(lapply(speciesToShow, GetSpeciesColour)),  # colour hex values
       breaks = speciesToShow,  # species codes corresponding to each hex value
       labels = paste(lapply(speciesToShow, GetSpeciesName))  # species names for legend
     )
}

# Text identifying year range
YearRangeAsText <- function() {
   paste("from", 
         paste(min(df_filtered$hunt_year)), 
         "to", 
         paste(max(df_filtered$hunt_year))
   )
}
```

```{r}
# Total kills
plot_prov_species <- ggplot(data = df_filtered) +
  aes(x = hunt_year, y = total_kills, color = species) +
  FormatLines() +
  FormatPoints() +
  UseTheme() +
  UseSpeciesColours() +
  labs(x = paste("Year"),
       y = paste("Total # kills"),
       title = paste("Total kills", YearRangeAsText())
  )
print(plot_prov_species)
```


```{r}
# Total hunters
plot_prov_hunters <- ggplot(data = df_filtered) +
  aes(x = hunt_year, y = total_hunters, color = species) +
  FormatLines() +
  FormatPoints() +
  UseTheme() +
  UseSpeciesColours() +
  labs(x = paste("Year"),
       y = paste("Total # hunters"),
       title = paste("Total hunters", YearRangeAsText())
  )
print(plot_prov_hunters)
```


```{r}
# Avg kills per hunter
plot_prov_killsperhunter <- ggplot(data = df_filtered) +
  aes(x = hunt_year, y = kills_per_hunter, color = species) +
  FormatLines() +
  FormatPoints() +
  UseTheme() +
  UseSpeciesColours() +
  labs(x = paste("Year"),
       y = paste("Avg kills per hunter"),
       title = paste("Average kills per hunter", YearRangeAsText())
  )
print(plot_prov_killsperhunter)
```
```{r}
# Total hunting days
plot_prov_totaldays <- ggplot(data = df_filtered) +
  aes(x = hunt_year, y = total_days, color = species) +
  FormatLines() +
  FormatPoints() +
  UseTheme() +
  UseSpeciesColours() +
  labs(x = paste("Year"),
       y = paste("Total # hunting days"),
       title = paste("Total # hunting days", YearRangeAsText())
  )
print(plot_prov_totaldays)
```

```{r}
# Avg hunting days per hunter
plot_prov_daysperhunter <- ggplot(data = df_filtered) +
  aes(x = hunt_year, y = days_per_hunter, color = species) +
  FormatLines() +
  FormatPoints() +
  UseTheme() +
  UseSpeciesColours() +
  labs(x = paste("Year"),
       y = paste("Avg hunt days per hunter"),
       title = paste("Average # hunting days per hunter", YearRangeAsText())
  )
print(plot_prov_daysperhunter)
```

```{r}
# Avg hunting days per kill
plot_prov_daysperhunter <- ggplot(data = df_filtered) +
  aes(x = hunt_year, y = days_per_kill, color = species) +
  FormatLines() +
  FormatPoints() +
  UseTheme() +
  UseSpeciesColours() +
  labs(x = paste("Year"),
       y = paste("Avg hunt days per kill"),
       title = paste("Average # hunting days per kill", YearRangeAsText())
  )
print(plot_prov_daysperhunter)
```



```{r}
# Resident hunters of each species
plot_prov_speciesres <- ggplot(data = df_filtered) +
  aes(x = hunt_year, y = resident_hunters, color = species) +
  FormatLines() +
  FormatPoints() +
  UseTheme() +
  UseSpeciesColours() +
  labs(x = paste("Year"),
       y = paste("# resident hunters"),
       title = paste("Resident hunters", YearRangeAsText())
  )
print(plot_prov_speciesres)
```

```{r}
# Non-resident hunters of each species
plot_prov_speciesnonres <- ggplot(data = df_filtered) +
  aes(x = hunt_year, y = non_resident_hunters, color = species) +
  FormatLines() +
  FormatPoints() +
  UseTheme() +
  UseSpeciesColours() +
  labs(x = paste("Year"),
       y = paste("# non-resident hunters"),
       title = paste("Non-resident hunters", YearRangeAsText())
  )
print(plot_prov_speciesnonres)
```

```{r}
# Resident hunters of each species, normalized to BC population
plot_prov_speciesresfrac <- ggplot(data = df_filtered) +
  aes(x = hunt_year, y = resident_hunters/population_human, color = species) +
  FormatLines() +
  FormatPoints() +
  UseTheme() +
  UseSpeciesColours() +
  labs(x = paste("Year"),
       y = paste("# resident hunters/total BC population"),
       title = paste("Resident hunters as fraction of BC population", YearRangeAsText())
  )
print(plot_prov_speciesresfrac)
```

```{r}
# Total resident and non-resident hunters
# Note that each individual hunter is probably counted multiple times, because a lot of them probably have more than one tag
hunters_residence <- df_filtered %>% 
  group_by(hunt_year) %>% 
  summarise(
    across(resident_hunters, sum, na.rm=TRUE),
    across(non_resident_hunters, sum, na.rm=TRUE),
  ) %>% 
  pivot_longer(cols = !hunt_year, names_to = "residency", values_to = "n_hunters") %>% 
  left_join(df_pop_years, by = c("hunt_year" = "year"))

plot_prov_totalresnonres <- ggplot(data = hunters_residence) +
  aes(x = hunt_year, y = n_hunters, color = residency) +
  FormatLines() +
  FormatPoints() +
  UseTheme() +
  labs(x = paste("Year"),
       y = paste("# hunters"),
       title = paste("Total resident and non-resident hunters", YearRangeAsText())
  )
print(plot_prov_totalresnonres)
```



```{r}
plot_prov_totalresfrac <- ggplot(data = filter(hunters_residence, residency == "resident_hunters")) +
  aes(x = hunt_year, y = n_hunters/population_human) +
  FormatLines() +
  FormatPoints() +
  UseTheme() +
  labs(x = paste("Year"),
       y = paste("# hunters/BC population"),
       title = paste("Total resident hunters as a fraction of BC population", YearRangeAsText())
  )
print(plot_prov_totalresfrac)
```

```{r}
plot_bcpop <- ggplot(data = df_pop_years) +
  aes(x = year, y = population_human) +
  FormatLines() +
  FormatPoints() +
  UseTheme() +
  labs(x = paste("Year"),
       y = paste("BC population"),
       title = paste("BC population", YearRangeAsText())
  )
print(plot_bcpop)
```


```{r}
# Avg kills per hunter, separated by hunter residency
plot_prov_killsperhunter_resident <- ggplot(data = df_filtered) +
  aes(x = hunt_year, y = resident_kills/resident_hunters, color = species) +
  FormatLines() +
  FormatPoints() +
  UseTheme() +
  UseSpeciesColours() +
  labs(x = paste("Year"),
       y = paste("Avg kills per resident hunter"),
       title = paste("Average kills per resident hunter", YearRangeAsText())
  )
print(plot_prov_killsperhunter_resident)
```

```{r}
plot_prov_killsperhunter_nonresident <- ggplot(data = df_filtered) +
  aes(x = hunt_year, y = non_resident_kills/non_resident_hunters, color = species) +
  FormatLines() +
  FormatPoints() +
  UseTheme() +
  UseSpeciesColours() +
  labs(x = paste("Year"),
       y = paste("Avg kills per non-resident hunter"),
       title = paste("Average kills per non-resident hunter", YearRangeAsText())
  )
print(plot_prov_killsperhunter_nonresident)
```

```{r}
# Avg hunting days per kill, separated by hunter residency
plot_prov_daysperhunter_resident <- ggplot(data = df_filtered) +
  aes(x = hunt_year, y = resident_days/resident_kills, color = species) +
  FormatLines() +
  FormatPoints() +
  UseTheme() +
  UseSpeciesColours() +
  labs(x = paste("Year"),
       y = paste("Avg hunt days per kill"),
       title = paste("Average # hunting days per kill for resident hunters", YearRangeAsText())
  )
print(plot_prov_daysperhunter_resident)
```

```{r}
plot_prov_daysperhunter_nonresident <- ggplot(data = df_filtered) +
  aes(x = hunt_year, y = non_resident_days/non_resident_kills, color = species) +
  FormatLines() +
  FormatPoints() +
  UseTheme() +
  UseSpeciesColours() +
  labs(x = paste("Year"),
       y = paste("Avg hunt days per kill"),
       title = paste("Average # hunting days per kill for non-resident hunters", YearRangeAsText())
  )
print(plot_prov_daysperhunter_nonresident)
```

```{r}
total_allspecies <- df_filtered %>% 
  group_by(hunt_year) %>% 
  summarise(
    across(resident_kills, sum, na.rm=TRUE),
    across(non_resident_kills, sum, na.rm=TRUE),
  ) %>% 
  pivot_longer(cols = !hunt_year, names_to = "residency", values_to = "n_kills")

plot_prov_totalkills <- ggplot(data = total_allspecies) +
  aes(x = hunt_year, y = n_kills, color = residency) +
  FormatLines() +
  FormatPoints() +
  UseTheme() +
  labs(x = paste("Year"),
       y = paste("Total kills"),
       title = paste("Total kills", YearRangeAsText())
  )
print(plot_prov_totalkills)
```

```{r}
# Map of WMUs

# Add fields to separate region 7 into 7A and 7B (region code and region name)
# Input:  WMU number as string
# Output:  Hunting region number as string
GetRegionCode <- function(wmuID) {
  regionString <- df_wmuRegions %>% 
    filter(wmu_string==wmuID) %>% 
    pull(region)  # return column as a vector
  return(regionString)
}
# Input:  Hunting region number as string
# Output:  Hunting region name as string
GetRegionName <- function(regionID) {
  regionName <- df_regionNames %>% 
    filter(region==regionID) %>% 
    pull(name)  # return column as a vector
  return(regionName)
}
sp_wmus@data$HUNTING_REGION <- unlist(lapply(sp_wmus$WILDLIFE_MGMT_UNIT_ID, 
                                          GetRegionCode))
sp_wmus@data$HUNTING_REGION_NAME <- unlist(lapply(sp_wmus$HUNTING_REGION, 
                                          GetRegionName))

# Check total areas add to area of BC (944,735 km^2)
# Note that the geojson areas include a bunch of water so we expect a higher estimate
#testarea <- sum(wmus$FEATURE_AREA_SQM/(1000^2))

# GENERATE COLOUR PALETTE
# Show possible colour schemes
#display.brewer.all()
mapColours <- colorFactor(
  palette = brewer.pal(length(unique(sp_wmus$HUNTING_REGION)), "Set3"),
  levels = unique(sp_wmus$HUNTING_REGION)
  )

# PREPARE LABELS
# Labels to show on each WMU all the time
wmu_static_labels <- lapply(sp_wmus@polygons, function(x) {x@labpt}) %>% 
  unlist() %>% 
  matrix(., nrow = length(.), ncol = 2, byrow = TRUE) %>% 
  as_tibble() %>% 
  cbind(sp_wmus$WILDLIFE_MGMT_UNIT_ID)
colnames(wmu_static_labels) <- c("long", "lat", "WMU")
# Labels to show on each WMU when hovering
#https://stackoverflow.com/a/43155126
wmu_hover_labels <- lapply(seq(nrow(sp_wmus)),
                           function(x) {
                             paste(
                               paste(
                                 "<b>WMU # ", 
                                 sp_wmus$WILDLIFE_MGMT_UNIT_ID[x], 
                                 "</b>", 
                                 sep = ''
                                 ),
                               paste(
                                 format(
                                   round(as.numeric(sp_wmus$FEATURE_AREA_SQM[x] / (1000 ^ 2))),
                                   big.mark = ","
                                   ), 
                                 "km^2"
                                 ),
                               paste(
                                 "Hunting region: ",
                                 sp_wmus$HUNTING_REGION[x],
                                 " (",
                                 sp_wmus$HUNTING_REGION_NAME[x],
                                 ")",
                                 sep = ''
                                 ),
                               # https://stackoverflow.com/a/29465942
                               paste(
                                 "Game management zone: ",
                                 sp_wmus$GAME_MANAGEMENT_ZONE_ID[x],
                                 " (",
                                 sp_wmus$GAME_MANAGEMENT_ZONE_NAME[x],
                                 ")",
                                 sep = ''
                               ),
                               sep = "<br/>"
                             )
                           })

# CREATE MAP
leaflet(sp_wmus) %>% 
  addTiles(tilesURL) %>% 
  addPolygons(stroke = TRUE,
              weight = 2,
              opacity = 1,
              fillOpacity = 0.4,
              color = ~mapColours(HUNTING_REGION),
              label = lapply(wmu_hover_labels, htmltools::HTML),
              labelOptions = labelOptions(
                direction = "top"),  # labels on hover:  https://stackoverflow.com/a/43155126
  highlight = highlightOptions(color = "red",
                                      fillColor = "red",
                                      weight = 2,
                                      bringToFront = TRUE)  # bring hovered-over polygon to front
  ) %>% 
  addLabelOnlyMarkers(data = wmu_static_labels,  # labels always on polygons
                      lng = ~long, 
                      lat = ~lat, 
                      label = ~WMU,
                      labelOptions = labelOptions(
                        noHide = TRUE, 
                        direction = 'auto', 
                        textOnly = TRUE,
                        style = list(
                          "color" = "grey"
                          )
                        )
                      )

```

```{r}
# SHOW HUNTING REGIONS ON MAP

# WMU codes in hunting data are e.g. 101, 115
#   - codes ending in 00 denote values from that hunting region but unknown WMU
#   - codes ending in 99 denote totals for that hunting region
#   - code 999 is province-wide total
# WMU codes in geojson are e.g. 1-1, 1-15

# Group WMU boundaries into hunting regions
# https://gis.stackexchange.com/a/225731
sp_huntingRegions <- gUnaryUnion(sp_wmus, id = sp_wmus@data$HUNTING_REGION)
# ID of each polygon is hunting region.  Get these as dataframe, to be added to SpatialPolygons.  When dataframe is added to SpatialPolygons data, column names will be converted to SpatialPolygons tags and row names must be the same as polygon IDs, so set these appropriately.
# https://willchernoff.com/2012/10/08/add-attribute-data-to-object-of-class-spatialpolygonsdataframe-in-r/
# To get polygon IDs:  https://r.789695.n4.nabble.com/How-extract-the-names-of-ID-in-SpatialPolygons-object-td790614.html
hunting_regions_data <- tibble(
  sapply(slot(sp_huntingRegions, "polygons"), function(x) slot(x, "ID"))
  )
colnames(hunting_regions_data) <- c("HUNTING_REGION_ID")
rownames(hunting_regions_data) <- hunting_regions_data$HUNTING_REGION_ID
# Convert to SpatialPolygons dataframe so that we can add data for each region
sp_huntingRegions <- SpatialPolygonsDataFrame(sp_huntingRegions, 
                                            hunting_regions_data
                                            )

# ADD DATA TO SPATIALPOLYGONDATAFRAME
# NAME of each hunting region
sp_huntingRegions@data$HUNTING_REGION_NAME <- unlist(lapply(sp_huntingRegions$HUNTING_REGION_ID, 
                                          GetRegionName))
# AREA of each hunting region (km^2)
# Note that "area" in a polygon class is NOT the projected area, but rather a planar area measurement used to ensure smaller polygons are plotted after larger ones:  https://www.rdocumentation.org/packages/sp/versions/1.4-4/topics/Polygons-class
# Instead, from the rgeos package use gArea() (for projected coordinates) or from the geosphere package use areaPolygon() (for lat-long coordinates) (check the +proj= part of the SpatialPolygon file to find out which you are using):  https://stackoverflow.com/a/8708828
sp_huntingRegions@data$HUNTING_REGION_AREA <- areaPolygon(sp_huntingRegions)/(1000^2)

# PREPARE LABELS
# Labels to show on each hunting region all the time
# This also finds the centroid of each hunting region, to know where to place the labels.
hunting_region_static_labels <- gCentroid(sp_huntingRegions, byid = TRUE) %>% 
  as_tibble() %>% 
  cbind(seq(length(sp_huntingRegions)))
colnames(hunting_region_static_labels) <- c("long", "lat", "hunting_region")
# Labels to show on each hunting region when hovering
hunting_region_hover_labels <- lapply(seq(nrow(sp_huntingRegions)),
                           function(x) {
                             paste(
                               paste(
                                 "<b>Hunting region ", 
                                 sp_huntingRegions$HUNTING_REGION_ID[x], 
                                 " (",
                                 sp_huntingRegions$HUNTING_REGION_NAME[x],
                                 ")",
                                 "</b>", 
                                 sep = ''
                                 ),
                               paste(
                                 format(
                                   round(sp_huntingRegions$HUNTING_REGION_AREA[x]),
                                   big.mark = ",",
                                   ), 
                                 "km^2"
                                 ),
                               sep = "<br/>"
                             )
                           })

# Show on map
leaflet(sp_huntingRegions) %>% 
  addTiles(tilesURL) %>% 
  addPolygons(stroke = TRUE,
              weight = 2,
              opacity = 1,
              fillOpacity = 0.4,
              color = ~mapColours(HUNTING_REGION_ID),
              label = lapply(hunting_region_hover_labels, htmltools::HTML),
              labelOptions = labelOptions(
                direction = "top"),  # labels on hover:  https://stackoverflow.com/a/43155126
              highlight = highlightOptions(color = "red",
                                                  fillColor = "red",
                                                  weight = 2,
                                                  bringToFront = TRUE)  # bring hovered-over polygon to front
              ) %>% 
  addLabelOnlyMarkers(data = hunting_region_static_labels,  # labels always on polygons
                      lng = ~long, 
                      lat = ~lat, 
                      label = ~hunting_region,
                      labelOptions = labelOptions(
                        noHide = TRUE, 
                        direction = 'auto', 
                        textOnly = TRUE,
                        style = list(
                          "color" = "grey"
                          )
                        )
                      )
```

